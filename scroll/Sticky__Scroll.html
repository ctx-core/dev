<:Window
  on:scroll="reset(event)"
  on:resize="reset(event)"
/>

<div ref:target class="Sticky__Scroll {{class__root || ''}}">
  {{yield}}
</div>

<script type="buble">
  import {$_is__visible
        , $_is__active} from 'ctx-core/scroll/lib.mjs'
  import {log,debug} from 'ctx-core/logger/lib.mjs'
  const logPrefix = 'ctx-core/sticky__scroll__header/Sticky__Scroll.html'
  export default {
    oncreate,
    ondestroy,
    data() {
      return {
        getBoundingClientRect,
        terminal: null
      }
    },
    methods: {
      reset
    }
  }
  function oncreate() {
    log(`${logPrefix}|oncreate`)
    const C = this
        , terminal = C.get('terminal')
    reset.call(C)
    if (terminal) {
      if (terminal.addEventListener) {
        terminal.addEventListener('scroll', onscroll__terminal)
      } else if (terminal.on) {
        terminal.on('scroll', onscroll__terminal)
      }
    }
    function onscroll__terminal() {
      log(`${logPrefix}|onscroll__terminal`)
      reset.call(C)
    }
  }
  function ondestroy() {
    log(`${logPrefix}|ondestroy`)
    const C = this
        , {target} = C.refs
    if (contains__visible(target)) {
      remove__visible(C, target)
    }
    if (contains__active(target)) {
      remove__active(C, target)
    }
  }
  function getBoundingClientRect(target) {
    return target.getBoundingClientRect()
  }
  function reset() {
    const C = this
        , getBoundingClientRect = C.get('getBoundingClientRect')
        , {target} = C.refs
        , {top, bottom} = getBoundingClientRect(target)
        , {innerHeight} = window
        , active = $_is__active(top, bottom)
        , visible = $_is__visible(top, bottom, innerHeight)
    if (visible) {
      if (!contains__visible(target)) {
        add__visible(C, target)
      }
    } else {
      if (contains__visible(target)) {
        remove__visible(C, target)
      }
    }
    if (active) {
      if (!contains__active(target)) {
        add__active(C, target)
      }
    } else {
      if (contains__active(target)) {
        remove__active(C, target)
      }
    }
  }
  function contains__visible(target) {
    return target.classList.contains('visible')
  }
  function contains__active(target) {
    return target.classList.contains('active')
  }
  function add__visible(C, target) {
    target.classList.add('visible')
    C.fire('add__visible', {target, currentTarget: target})
  }
  function remove__visible(C, target) {
    target.classList.remove('visible')
    C.fire('remove__visible', {target, currentTarget: target})
  }
  function add__active(C, target) {
    target.classList.add('active')
    C.fire('add__active', {target, currentTarget: target})
  }
  function remove__active(C, target) {
    target.classList.remove('active')
    C.fire('remove__active', {target, currentTarget: target})
  }
</script>