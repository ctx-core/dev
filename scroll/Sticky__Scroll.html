<:Window
  on:scroll="reset(event, target)"
  on:resize="reset(event, target)"
/>

<div ref:target class="Sticky__Scroll {{class__root || ''}}">
  <slot></slot>
</div>

<script type="buble">
  import {$is__visible__
        , $is__active__} from 'ctx-core/scroll/lib.mjs'
  import {log,debug} from 'ctx-core/logger/lib.mjs'
  const logPrefix = 'ctx-core/sticky__scroll__header/Sticky__Scroll.html'
  export default {
    oncreate,
    ondestroy,
    data() {
      return {
        getBoundingClientRect,
        terminal: null
      }
    },
    methods: {
      reset
    }
  }
  function oncreate() {
    log(`${logPrefix}|oncreate`)
    const C = this
        , {target} = C.refs
        , terminal = C.get('terminal')
    C.set({target})
    reset.call(C, target)
    if (terminal) {
      if (terminal.addEventListener) {
        terminal.addEventListener('scroll', onscroll__terminal)
      } else if (terminal.on) {
        terminal.on('scroll', onscroll__terminal)
      }
    }
    function onscroll__terminal() {
      log(`${logPrefix}|onscroll__terminal`)
      reset.call(C, target)
    }
  }
  function ondestroy() {
    log(`${logPrefix}|ondestroy`)
    const C = this
        , target = C.get('target')
    if (contains__visible(target)) {
      remove__visible(C, target)
    }
    if (contains__active(target)) {
      remove__active(C, target)
    }
  }
  function getBoundingClientRect(target) {
    return target.getBoundingClientRect()
  }
  // TODO: Use C.refs.target when issue https://github.com/sveltejs/svelte/issues/960 is fixed
  function reset(target) {
    const C = this
        , getBoundingClientRect__ =
            C.get('getBoundingClientRect')
            || getBoundingClientRect
        , {top, bottom} = getBoundingClientRect__(target)
        , {innerHeight} = window
        , active = $is__active__(top, bottom)
        , visible = $is__visible__(top, bottom, innerHeight)
    if (visible) {
      if (!contains__visible(target)) {
        add__visible(C, target)
      }
    } else {
      if (contains__visible(target)) {
        remove__visible(C, target)
      }
    }
    if (active) {
      if (!contains__active(target)) {
        add__active(C, target)
      }
    } else {
      if (contains__active(target)) {
        remove__active(C, target)
      }
    }
  }
  function contains__visible(target) {
    return target.classList.contains('visible')
  }
  function contains__active(target) {
    return target.classList.contains('active')
  }
  function add__visible(C, target) {
    target.classList.add('visible')
    C.fire('add__visible', {target, currentTarget: target})
  }
  function remove__visible(C, target) {
    target.classList.remove('visible')
    C.fire('remove__visible', {target, currentTarget: target})
  }
  function add__active(C, target) {
    target.classList.add('active')
    C.fire('add__active', {target, currentTarget: target})
  }
  function remove__active(C, target) {
    target.classList.remove('active')
    C.fire('remove__active', {target, currentTarget: target})
  }
</script>