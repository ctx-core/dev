{#if children}
	<Knob__Tree__Checkbox
		expanded="{expanded}"
		on:click="__click__knob(event)"
	></Knob__Tree__Checkbox>
{/if}
<Input__Tree__Checkbox
	{id}
	{title}
	bind:indeterminate
	bind:checked
	on:change="__change__input(event)"
></Input__Tree__Checkbox>
{#if expanded}
	<slot></slot>
{/if}

<script>
	import Knob__Tree__Checkbox from './Knob__Tree__Checkbox.html'
	import Input__Tree__Checkbox from './Input__Tree__Checkbox.html'
	import { log, debug } from '@ctx-core/logger/lib.mjs'
	const logPrefix = '@ctx-core/tree__checkbox/Node__Tree__Checkbox.html'
	export default {
		onstate({ changed, current }) {
			if (changed.children) {
				log(`${logPrefix}|onstate|children`)
				const { children } = current
				if (children) {
					const { keys__children } = this.get()
					let has__true
					let has__false
					let checked
					let indeterminate
					for (let i = 0; i < keys__children.length; i++) {
						const key__child = keys__children[i]
						const child = children[key__child]
						has__true = has__true || !!child
						has__false = has__false || !child
					}
					checked = has__true && !has__false
					indeterminate = has__true && has__false
					this.set({ checked, indeterminate })
				}
			}
		},
		methods: {
			__click__knob(e) {
				log(`${logPrefix}|__click__knob`)
				e.preventDefault()
				this.set({
					expanded: !this.get().expanded
				})
			},
			__change__input(e) {
				log(`${logPrefix}|__change__input`)
				const { currentTarget } = e
				const { checked } = currentTarget
				const { children, keys__children } = this.get()
				const __set = {}
				if (checked) {
					__set.expanded = true
				}
				if (children && keys__children) {
					for (let i = 0; i < keys__children.length; i++) {
						const key__child = keys__children[i]
						children[key__child] = checked
					}
					__set.children = children
					__set.indeterminate = false
				}
				this.set(__set)
				this.fire('change', e)
			}
		},
		components: {
			Knob__Tree__Checkbox,
			Input__Tree__Checkbox
		}
	}
</script>