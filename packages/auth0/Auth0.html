<script>
	import { keys } from '@ctx-core/object'
	import { _class } from '@ctx-core/html'
	import { __errors__token__auth0 } from '@ctx-core/auth0/store'
	import {
		onMount__auth0,
		__close,
		__submit__login,
		__submit__signup,
		__submit__forgot_password,
		__submit__change_password,
	} from './Auth0.html.js'
	import Close__Dialog from '@ctx-core/dialog/Close__Dialog.html'
	import { log, debug } from '@ctx-core/logger'
	const logPrefix = '@ctx-core/auth0/auth0.html'
	let password__change_password
	let password_confirmation__change_password
	let email__forgot_password
	let password__signup
	let password_confirmation__signup
	let username__login
	let password__login
	onMount__auth0()
	$: errors__username = $__errors__token__auth0 && $__errors__token__auth0.username
	$: errors__email = $__errors__token__auth0 && $__errors__token__auth0.email
	$: errors__password = $__errors__token__auth0 && $__errors__token__auth0.password
	$: errors__password_confirmation = $__errors__token__auth0 && errors__password_confirmation
	$: error_codes = ($__errors__token__auth0 && keys($__errors__token__auth0)) || []
	$: class__root = _class(
		{ visible: !!$__class__opened__auth0 },
		$__class__opened__auth0)
</script>

<div class="Auth0 {class__root}">
	{#if !$__class__opened__auth0 || $__class__opened__auth0 == 'signup'}
		<div class="form signup">
			<Close__Dialog on:close={__close}></Close__Dialog>
			<h1>Sign Up</h1>
			<form
				action="https://{$__AUTH0_DOMAIN}/dbconnections/signup"
				accept-charset="UTF-8"
				method="post"
				on:submit={__submit__signup}
			>
				<ul>
					{#each error_codes as error_code}
						<li class="error">{$__errors__token__auth0[error_code]}</li>
					{/each}
				</ul>
				<fieldset>
					<label class="field">
						<div>Email</div>
						<input
							bind:this="{email__signup}"
							placeholder="your@email.com"
							required="required"
							autocomplete="email"
							class="form-control {
								_class({invalid: errors__email})
							}"
							type="text"
							id="email-signup"
							name="email"/>
					</label>
					<label class="field">
						<div>Password</div>
						<input
							bind:this="{password__signup}"
							placeholder="**********"
							required="required"
							class="{
								_class({invalid: errors__password})
							}"
							id="password-signup"
							type="password"
							name="password"/>
					</label>
					<label class="field">
						<div>Confirm Password</div>
						<input
							bind:this="{password_confirmation__signup}"
							placeholder="**********"
							required="required"
							class="{
								_class({invalid: errors__password_confirmation})
							}"
							type="password"
							name="password_confirmation"
							id="password_confirmation-signup"/>
					</label>
					<p>
						By clicking ‘Sign up’ you agree to the terms of this Website <br>
						<a href="." target="_blank">Terms of Service</a>
						and
						<a href="." target="_blank">Privacy Policy</a>
					</p>
				</fieldset>
				<footer>
					<input type="submit" value="Sign up" class="button"/>
					<label
						class="navigation__auth"
						on:click="{event => __class__opened__auth0.set('login')}"
					>Have an account? Login&hellip;</label>
					<label
						class="navigation__auth"
						on:click="{event => __class__opened__auth0.set('forgot_password')}"
					>Forgot Password?</label>
				</footer>
			</form>
		</div>
	{:else if $__class__opened__auth0 == 'login'}
		<div class="form login">
			<Close__Dialog on:close={__close}></Close__Dialog>
			<h1>Login</h1>
			<form
				action="https://{$__AUTH0_DOMAIN}/oauth/token"
				accept-charset="UTF-8"
				method="post"
				on:submit={__submit__login}
			>
				<ul>
					{#each error_codes as error_code}
						<li class="error">{$__errors__token__auth0[error_code]}</li>
					{/each}
				</ul>
				<fieldset>
					<label class="field">
						<div>Email</div>
						<input
							bind:this="{username__login}"
							placeholder="your@email.com"
							required="required"
							class="form-control {
								_class({invalid: errors__username})
							}"
							type="text"
							id="username-login"
							name="username"/>
					</label>
					<label class="field">
						<div>Password</div>
						<input
							bind:this="{password__login}"
							placeholder="**********"
							required="required"
							class="&#123;invalid: errors__password}"
							id="password-login"
							type="password"
							name="password"/>
					</label>
				</fieldset>
				<footer>
					<input type="submit" value="Login" class="button"/>
					<label
						class="navigation__auth"
						on:click="{event => __class__opened__auth0.set('signup')}"
					>Don't have an account? Signup&hellip;</label>
					<label
						class="navigation__auth"
						on:click="{event => __class__opened__auth0.set('forgot_password')}"
					>Forgot Password?</label>
				</footer>
			</form>
		</div>
	{:else if $__class__opened__auth0 == 'forgot_password'}
		<div class="form forgot_password">
			<Close__Dialog on:close={__close}></Close__Dialog>
			<h1>Forgot Password</h1>
			<form
				action="https://{$__AUTH0_DOMAIN}/passwordless/start"
				accept-charset="UTF-8"
				method="post"
				on:submit="{event => __submit__forgot_password(event, { email__forgot_password })}"
			>
				<ul>
					{#each error_codes as error_code}
						<li class="error">{$__errors__token__auth0[error_code]}</li>
					{/each}
				</ul>
				<fieldset>
					<label class="field">
						<div>Email</div>
						<input
							bind:this={email__forgot_password}
							placeholder="your@email.com"
							required="required"
							class="form-control {
								_class({invalid: errors__email})
							}"
							type="text"
							id="email-forgot_password"
							name="email"/>
					</label>
				</fieldset>
				<footer>
					<input type="submit" value="Reset Password" class="button"/>
					<label
						class="navigation__auth"
						on:click="{event => __class__opened__auth0.set('login')}"
					>Have an account? Login&hellip;</label>
					<label
						class="navigation__auth"
						on:click="{event => __class__opened__auth0.set('signup')}"
					>Don't have an account? Signup&hellip;</label>
				</footer>
			</form>
		</div>
	{:else if $__class__opened__auth0 == 'check_email'}
		<div class="form forgot_password__check_email">
			<Close__Dialog on:close={__close}></Close__Dialog>
			<h1>Check Your Email</h1>
			<p>An email to reset you password has been sent to you.</p>
		</div>
	{:else if $__class__opened__auth0 == 'change_password'}
		<div class="form change_password">
			<Close__Dialog on:close={__close}></Close__Dialog>
			<h1>Change Password</h1>
			<form
				action="https://{$__AUTH0_DOMAIN}/dbconnections/change_password"
				accept-charset="UTF-8"
				method="post"
				on:submit="{
					event =>
						__submit__change_password(event, {
							password__change_password,
							password_confirmation__change_password,
						})
				}"
			>
			<ul>
				{#each error_codes as error_code}
					<li class=" error">{$__errors__token__auth0[error_code]}</li>
				{/each}
			</ul>
			<fieldset>
				<label class="field">
					<div>Password</div>
					<input
						bind:this={password__change_password}
						placeholder="**********"
						required="required"
						class="{
							_class({invalid: errors__password})
						}"
						id="password-change_password"
						type="password"
						name="password"/>
				</label>
				<label class="field">
					<div>Confirm Password</div>
					<input
						bind:this={password_confirmation__change_password}
						placeholder="**********"
						required="required"
						class="{
							_class({invalid: errors__password_confirmation})
						}"
						type="password"
						name="password_confirmation"
						id="password_confirmation-change_password"/>
				</label>
				</fieldset>
				<footer>
					<input type="submit" value="Change Password" class="button"/>
				</footer>
			</form>
		</div>
	{/if}
	<slot></slot>
</div>

<style type="text/scss">
	.Auth0 {
		display: block;
		overflow: hidden;
		height: 500px;
		padding-top: 1rem;
		h1 {
			font-size: 2rem;
		}
		[name=navigation__auth] {
			display: none;
			~ .form {
				display: none;
			}
			&.navigation__auth-signup:checked {
				~ .signup {
					display: block;
				}
			}
			&.navigation__auth-login:checked {
				~ .login {
					display: block;
				}
			}
			&.navigation__auth-forgot_password:checked {
				~ .forgot_password {
					display: block;
				}
			}
			&.navigation__auth-forgot_password__check_email:checked {
				~ .forgot_password__check_email {
					display: block;
				}
			}
			&.navigation__auth-change_password:checked {
				~ .change_password {
					display: block;
				}
			}
		}
		label.navigation__auth {
			color: #3EBBC0;
			font-weight: bold;
			&:hover {
				text-decoration: underline;
			}
		}
		> div {
			position: relative;
			height: 100%;
			> :global(.close) {
				position: absolute;
				right: 0;
			}
		}
		form {
			input {
				border-bottom: 2px solid transparent;
				&.invalid {
					border-color: red;
				}
			}
			label {
				display: block;
			}
			fieldset {
				clear: both;
				border: none;
				.field {
					width: 20em;
					margin: 0 auto;
					display: block;
					overflow: hidden;
					clear: both;
					text-align: left;
					input {
						display: block;
						width: 100%;
						padding: 0.2em;
						color: black;
					}
				}
				p {
					margin-bottom: 0;
					-webkit-margin-after: 0;
				}
			}
			footer {
				margin-top: 1rem;
				text-align: center;
				.button {
					float: none;
					width: 10em;
					padding: 0.4rem;
					background-color: #3EBBC0;
					border-radius: 5px;
					border: none;
					&:hover {
						background-color: #5CC6CA;
					}
				}
				label {
					margin-top: 1em;
				}
			}
		}
		.error {
			color: red;
		}
	}
</style>
